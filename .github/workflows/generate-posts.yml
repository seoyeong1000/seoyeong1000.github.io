name: Generate posts.json and Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

# GitHub Pagesì— ë°°í¬í•˜ê¸° ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate posts.json
        run: |
          echo "ğŸ“ Generating posts.json from markdown files..."

          # posts.json ìƒì„± ìŠ¤í¬ë¦½íŠ¸
          node -e "
          const fs = require('fs');
          const path = require('path');

          console.log('ğŸ” Scanning pages directory...');

          // pages ë””ë ‰í† ë¦¬ í™•ì¸
          const pagesDir = 'pages';
          if (!fs.existsSync(pagesDir)) {
            console.log('âš ï¸  pages directory not found. Creating empty posts.json');
            fs.writeFileSync('posts.json', JSON.stringify([], null, 2));
            process.exit(0);
          }

          // ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ì°¾ê¸°
          const files = fs.readdirSync(pagesDir)
            .filter(file => file.endsWith('.md'));

          console.log(\`âœ… Found \${files.length} markdown files\`);

          const posts = [];

          files.forEach(file => {
            console.log(\`ğŸ“„ Processing: \${file}\`);
            const filePath = path.join(pagesDir, file);
            const content = fs.readFileSync(filePath, 'utf-8');
            
            // Front Matter íŒŒì‹±
            const frontMatterRegex = /^---\s*\n([\s\S]*?)\n---/;
            const match = content.match(frontMatterRegex);
            
            if (!match) {
              console.log(\`  âš ï¸  No front matter found in \${file}\`);
              return;
            }
            
            const frontMatter = match[1];
            const metadata = {};
            
            frontMatter.split('\n').forEach(line => {
              const colonIndex = line.indexOf(':');
              if (colonIndex === -1) return;
              
              const key = line.substring(0, colonIndex).trim();
              let value = line.substring(colonIndex + 1).trim();
              
              // ë”°ì˜´í‘œ ì œê±°
              value = value.replace(/^['\"']|['\"']$/g, '');
              
              // ë°°ì—´ íŒŒì‹±
              if (value.startsWith('[') && value.endsWith(']')) {
                value = value
                  .slice(1, -1)
                  .split(',')
                  .map(item => item.trim().replace(/^['\"']|['\"']$/g, ''))
                  .filter(item => item.length > 0);
              }
              
              metadata[key] = value;
            });
            
            // ê²Œì‹œê¸€ ì •ë³´ ì¶”ê°€
            posts.push({
              file: file,
              title: metadata.title || 'Untitled',
              date: metadata.date || new Date().toISOString().split('T')[0],
              tags: Array.isArray(metadata.tags) ? metadata.tags : [],
              category: metadata.category || 'Uncategorized',
              description: metadata.description || ''
            });
            
            console.log(\`  âœ… Added: \${metadata.title || file}\`);
          });

          // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
          posts.sort((a, b) => new Date(b.date) - new Date(a.date));

          // posts.json ìƒì„±
          fs.writeFileSync('posts.json', JSON.stringify(posts, null, 2));
          console.log(\`\nâœ… Successfully generated posts.json with \${posts.length} posts\`);
          "

      - name: Display posts.json
        run: |
          echo "ğŸ“‹ Generated posts.json content:"
          cat posts.json

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment complete
        run: |
          echo "ğŸš€ Deployment complete!"
          echo "ğŸŒ Your blog is live at: https://seoyeong1000.github.io"
